---
title: Jinja2 filtration bypass
date: 2022-07-30 09:00:00
tags:
    - python
    - xss
    - jinja2
categories:
    - research
    - programming
keywords:
    - markdown
    - code block
---

Начать стоит с того, что шаблонизатор jinja уже умеет автоматически экранировать все запрещенные символы, попадающие на страницу, тем самым защищая пользователя от таких уязвимостей, как cross site scripting(XSS) и SSTI(Server Site Template Injection). 

Отключить санитизацию символов можно при помощи блока 

```html
{$ autoescape false %}
```

Данный блок отключает автоматическое экранирование целых частей шаблона, что крайне не рекомендуется и может привести к XSS уязвимости. Но все же в jinja есть несколько кейсов, которые шаблонизатор не может обработать, приводя к уязвимости.

**Атрибут без ковычек**
HTML способен обработать атрибут, записанный без ковычек
```html
<div class=block></biv>
``` 
Подобная конструкция при использовании шаблонизатора является потенциальным векторм XSS, так как  злоумышленник может внедрить обработчики JavaScript, которым не требуются символы HTML.

```html
<div class={{user-input}}>
```
В данном случае пользователь способен внедрить следующий payload ```class onclick=alert()``` и в результате получится
```html
<div class="class" onclick=alert()>
```
При формировании DOM структуры сайта, кавычки атрибута ```class``` автоматически закроются, но внедренный атрибут останется на странице. Если ограничить атрибут кавычками, тогда приведенный выше payload не сработает, а выйти из кавычек, посредством добавления следующего пейлоада ```class" onclick"alert()``` не получится, ведь jinja отфильтрует входную кавычку, тем самым не допустив инъекции.

**Атрибут href**
Переменные шаблона в атрибуте ```href``` способны принимать схему ```javascript:```, что так же приводит к XSS уязвимости
```html
<a href"{{user-input}}"> click me </a>
<a href="javascript:alert()"> click me </a>
```
Предотвратить это позволяет использование ```url_for()``` для безопасного создания URL. Такая конструкция в Flask используется для создания URL-адреса, чтобы предотвратить изменение URL-адресов в приложении (в том числе в шаблонах).
```python
@app.route('/index')
@app.route('/')
def index():
    return 'you are in the index page'
```
Теперь мы имеем ссылку на индексную страницу и в шаблоне можем использовать это
```html
<a href={{ url_for('index') }}>Index</a>
```
